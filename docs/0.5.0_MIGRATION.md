# Migrating to agntcy-app-sdk 0.5.0

This guide walks you through updating your code from 0.4.x to 0.5.0. The release redesigns four main areas: how you create clients, how you set up servers, how topics work, and how transports are selected. Most changes are straightforward find-and-replace, and the new APIs are more concise once you're familiar with them.

---

## What Changed and Why

0.4.x used a single generic `factory.create_client("A2A", ...)` method for everything. This was flexible but untyped — you passed strings and keyword arguments, and the factory figured out what to do at runtime. Server setup required manually constructing `AppContainer` with a mix of positional and keyword args.

0.5.0 replaces this with:

- **Typed protocol accessors** (`factory.a2a()`, `factory.mcp()`, `factory.fast_mcp()`) that return protocol-specific factory objects with proper type hints and IDE auto-complete.
- **Card-driven transport negotiation** for A2A, where the `AgentCard` declares what transports the server supports and the `ClientConfig` declares what the client supports.
- **A fluent builder** for server setup that auto-detects handler types and eliminates boilerplate.

---

## Creating A2A Clients

This is the biggest change. The old `factory.create_client("A2A", ...)` is gone.

### Connecting to an agent over HTTP (simplest case)

```python
# OLD
factory = AgntcyFactory()
client = await factory.create_client("A2A", agent_url="http://localhost:9999")

# NEW
from agntcy_app_sdk import A2AClientFactory, ClientConfig

client = await A2AClientFactory.connect("http://localhost:9999")
```

`A2AClientFactory.connect()` fetches the agent card from the well-known URL, negotiates the transport, and returns a ready-to-use client. If you need to disable streaming (e.g. for a non-streaming server):

```python
client = await A2AClientFactory.connect(
    "http://localhost:9999",
    config=ClientConfig(streaming=False),
)
```

### Connecting over SLIM or NATS

In 0.4.x you passed `agent_topic` and `transport` directly. In 0.5.0 you configure a `ClientConfig` and build an `AgentCard` (or receive one from the server).

```python
# OLD
factory = AgntcyFactory()
transport = factory.create_transport("SLIM", endpoint="http://localhost:46357", name="org/ns/client")
client = await factory.create_client(
    "A2A",
    agent_url="http://localhost:9999",
    agent_topic="Hello_World_Agent_1.0.0",
    transport=transport,
)

# NEW
from agntcy_app_sdk import AgntcyFactory, ClientConfig

factory = AgntcyFactory()
transport = factory.create_transport("SLIM", endpoint="http://localhost:46357", name="org/ns/client")

config = ClientConfig(slim_transport=transport)
card = make_or_fetch_agent_card()  # see below
client = await factory.a2a(config).create(card)
```

You can also use **deferred configuration** — the transport is only built if the card selects it:

```python
from agntcy_app_sdk import ClientConfig, SlimTransportConfig

config = ClientConfig(
    slim_config=SlimTransportConfig(
        endpoint="http://localhost:46357",
        name="org/ns/client",
    ),
)
client = await factory.a2a(config).create(card)
```

### Where does the AgentCard come from?

- **From a URL:** `A2AClientFactory.connect("http://...")` handles this automatically.
- **Synthesized locally** (for transport-only tests or known agents):

```python
from a2a.types import AgentCard, AgentCapabilities
from agntcy_app_sdk.semantic.a2a.server.experimental_patterns import A2AExperimentalServer

# Define the base card (same fields the server uses, url can be empty)
base_card = AgentCard(
    name="Hello_World_Agent",
    url="",
    version="1.0.0",
    defaultInputModes=["text"],
    defaultOutputModes=["text"],
    capabilities=AgentCapabilities(),
    skills=[],
)

# Stamp preferred_transport and url to match what the server sets at startup
card = A2AExperimentalServer.create_client_card(base_card, "SLIM")  # or "NATS"
```

### Sending messages — return type changed

The `send_message` API now follows the upstream `a2a-sdk` client interface:

```python
# OLD — returned a SendMessageResponse directly
response = await client.send_message(request)  # request was SendMessageRequest
result = response.model_dump(mode="json")

# NEW — takes a Message, returns an async iterator of events
from a2a.types import Message

message = Message(
    role="user",
    parts=[{"type": "text", "text": "hello"}],
    messageId="1234",
)
async for event in client.send_message(message):
    print(event)
```

### Broadcast and group chat

These experimental methods are no longer monkey-patched onto the client. They are now real methods on `A2AExperimentalClient` (which is what `factory.a2a(config).create(card)` returns when a patterns transport is negotiated). The method signatures are unchanged:

```python
# Same as before — just real methods now
responses = await client.broadcast_message(request, recipients=[...])
chat_msgs = await client.start_groupchat(request, group_channel="chan", participants=[...])
```

---

## Creating MCP and FastMCP Clients

```python
# OLD
client = await factory.create_client("MCP", agent_topic="my_topic", transport=transport)

# NEW
client = await factory.mcp().create_client(topic="my_topic", transport=transport)
```

```python
# OLD
client = await factory.create_client("FastMCP", agent_topic="my_topic", transport=transport)

# NEW
client = await factory.fast_mcp().create_client(topic="my_topic", transport=transport)
```

---

## Setting Up Servers (AppContainer & AppSession)

### The fluent builder replaces direct AppContainer construction

```python
# OLD
from agntcy_app_sdk.app_sessions import AppContainer

container = AppContainer(
    server=a2a_server,
    transport=transport,
    topic="Hello_World_Agent_1.0.0",
)
session = factory.create_app_session(max_sessions=1)
session.add_app_container("my_session", container)
await session.start_all_sessions(keep_alive=True)

# NEW
session = factory.create_app_session(max_sessions=1)
session.add(a2a_server) \
    .with_transport(transport) \
    .with_topic("Hello_World_Agent_1.0.0") \
    .with_session_id("my_session") \
    .build()
await session.start_all_sessions(keep_alive=True)
```

The builder auto-detects the server type (`A2AStarletteApplication`, `MCPServer`, `FastMCP`) and wires up the correct handler internally.

### Serving A2A over plain HTTP (no transport)

Previously you had to manually run uvicorn. Now just omit `.with_transport()`:

```python
# OLD
from uvicorn import Config, Server
app = a2a_server.build()
config = Config(app=app, host="0.0.0.0", port=9999)
userver = Server(config)
await userver.serve()

# NEW
session.add(a2a_server) \
    .with_host("0.0.0.0") \
    .with_port(9999) \
    .with_session_id("http_session") \
    .build()
await session.start_all_sessions(keep_alive=True)
```

### Directory push is now automatic

Remove `push_to_directory_on_startup=True` from your `run()` / `start_all_sessions()` calls. If a directory is set, the container pushes to it automatically during startup.

```python
# OLD
await container.run(keep_alive=True, push_to_directory_on_startup=True)

# NEW — just set the directory on the builder
session.add(server) \
    .with_transport(transport) \
    .with_directory(my_directory) \
    .with_session_id("s1") \
    .build()
await session.start_all_sessions(keep_alive=True)
```

---

## Topic Generation

### Spaces are now replaced with underscores

If your agent name contains spaces, topics will look different:

| Version | Agent Name | Topic |
|---|---|---|
| 0.4.x | `"Hello World Agent"` | `"Hello World Agent_1.0.0"` |
| 0.5.0 | `"Hello World Agent"` | `"Hello_World_Agent_1.0.0"` |

If you were hardcoding topic strings that matched the old format, update them.

### Topics are auto-derived

In most cases you no longer need to call `create_agent_topic()` yourself. The `ContainerBuilder` derives the topic from the agent card when you don't provide one via `.with_topic()`.

### Topics are encoded in card.url

The server now stamps `card.url` with a scheme-prefixed topic (e.g. `slim://Hello_World_Agent_1.0.0`). This lets clients discover the topic from the card during transport negotiation. You generally don't need to think about this — it's handled automatically.

---

## Removed Imports

If you're importing any of these, they need to be removed or replaced:

| Old Import | Replacement |
|---|---|
| `from agntcy_app_sdk.factory import ProtocolTypes` | Use string literals (`"A2A"`, `"MCP"`, `"FastMCP"`) or `factory.registered_protocols()` |
| `from agntcy_app_sdk.factory import TransportTypes` | Use string literals (`"SLIM"`, `"NATS"`) or `factory.registered_transports()` |
| `from agntcy_app_sdk.factory import ObservabilityProviders` | Use `factory.registered_observability_providers()` |
| `from agntcy_app_sdk.factory import IdentityProviders` | Removed — no replacement needed |
| `from agntcy_app_sdk.semantic.a2a.protocol import A2AProtocol` | See sections above for client/server replacements |
| `from agntcy_app_sdk.semantic.base import BaseAgentProtocol` | Removed — use `ServerHandler` (server-side) or protocol accessors (client-side) |

## New Imports

```python
from agntcy_app_sdk import (
    AgntcyFactory,          # unchanged
    A2AClientFactory,       # new — typed A2A client factory
    MCPClientFactory,       # new — typed MCP client factory
    FastMCPClientFactory,   # new — typed FastMCP client factory
    AppSession,             # unchanged
    AppContainer,           # changed constructor (use builder instead)
    ClientConfig,           # new — A2A client configuration
    SlimTransportConfig,    # new — deferred SLIM transport config
    NatsTransportConfig,    # new — deferred NATS transport config
    SlimRpcConfig,          # new — deferred SLIM-RPC config
)
```

---

## Transport Creation — Minor Change

`factory.create_transport()` works the same way. The one difference: passing an unknown transport type now raises `ValueError` instead of returning `None`.

```python
# If you had this pattern:
transport = factory.create_transport(transport_type, endpoint=endpoint)
if transport is None:
    ...

# Change it to:
try:
    transport = factory.create_transport(transport_type, endpoint=endpoint)
except ValueError:
    ...
```

---

## Checklist

- [ ] Replace `factory.create_client("A2A", ...)` with `factory.a2a(config).create(card)` or `A2AClientFactory.connect(url)`
- [ ] Replace `factory.create_client("MCP", ...)` with `factory.mcp().create_client(...)`
- [ ] Replace `factory.create_client("FastMCP", ...)` with `factory.fast_mcp().create_client(...)`
- [ ] Replace `AppContainer(server, transport=..., topic=...)` with `session.add(server).with_transport(...).with_topic(...).build()`
- [ ] Remove `push_to_directory_on_startup=True` from `run()` and `start_all_sessions()` calls
- [ ] Update hardcoded topic strings if agent names contain spaces (spaces are now underscores)
- [ ] Remove imports of `ProtocolTypes`, `TransportTypes`, `A2AProtocol`, `BaseAgentProtocol`
- [ ] Update `send_message()` call sites — now takes `Message`, returns `AsyncIterator`
- [ ] Replace `transport is None` checks with `try/except ValueError`
