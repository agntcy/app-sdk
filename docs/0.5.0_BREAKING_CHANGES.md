# Breaking Changes

## Replace `create_client()` with typed protocol-specific accessors

### Removed

- **`AgntcyFactory.create_client()`** — removed entirely. Use the new typed accessor methods instead.
- **`ClientFactory`** ABC (`semantic/base.py`) — removed. `MCPClientFactory`, `FastMCPClientFactory`, and `A2AClientFactory` are no longer subclasses of a shared ABC.
- **`A2AClientFactory.create_client()`** — the bridge method that translated the legacy `(url, topic, transport)` calling convention into the card-driven API has been removed.
- **`A2AClientFactory._synthesise_card()`** — removed (was only used by the bridge).
- **`A2AClientFactory.protocol_type()`** — removed (was part of the `ClientFactory` ABC).
- **`ProtocolTypes`** enum — removed. Protocol discovery is now via the typed accessor methods (`.a2a()`, `.mcp()`, `.fast_mcp()`) and `registered_protocols()`.
- **`AgntcyFactory._client_factory_registry`** — removed.
- **`AgntcyFactory._register_wellknown_client_factories()`** — removed.
- **`AgntcyFactory._clients`** — removed.
- **`AgntcyFactory._bridges`** — removed.

### Added

- **`AgntcyFactory.a2a(config=None)`** — returns a typed `A2AClientFactory`. Accepts an optional `ClientConfig`.
- **`AgntcyFactory.mcp()`** — returns a typed `MCPClientFactory`.
- **`AgntcyFactory.fast_mcp()`** — returns a typed `FastMCPClientFactory`.

### Changed

- **`AgntcyFactory.registered_protocols()`** — now returns a static list `["A2A", "MCP", "FastMCP"]` derived from `_PROTOCOL_ACCESSORS` instead of reading from a registry dict.
- **`TransportTypes`** enum — removed entirely. Use `factory.registered_transports()` for CLI argparse choices and plain strings (`"SLIM"`, `"NATS"`) for defaults.

### Migration Guide

**A2A — Before:**

```python
client = await factory.create_client(
    "A2A",
    agent_topic="my_agent",
    transport=transport_instance,
)
```

**A2A — After (with transport):**

```python
from agntcy_app_sdk.semantic.a2a.client.config import ClientConfig
from a2a.types import AgentCard, AgentCapabilities

# Build a ClientConfig with the transport
config = ClientConfig(slim_transport=transport_instance)
a2a = factory.a2a(config)

# Use create() with an AgentCard
card = AgentCard(
    name="my_agent", url="slim://my_agent", version="1.0.0",
    defaultInputModes=["text"], defaultOutputModes=["text"],
    capabilities=AgentCapabilities(), skills=[],
    preferredTransport="slimpatterns",
)
client = await a2a.create(card)
```

**A2A — After (HTTP/JSONRPC):**

```python
from agntcy_app_sdk.semantic.a2a.client.factory import A2AClientFactory

# Convenience class method — resolves card from URL
client = await A2AClientFactory.connect("https://agent.example.com")
```

**MCP — Before:**

```python
mcp_client = await factory.create_client(
    "MCP", agent_topic="my_topic", transport=transport
)
```

**MCP — After:**

```python
mcp_client = await factory.mcp().create_client(
    topic="my_topic", transport=transport
)
```

**FastMCP — Before:**

```python
client = await factory.create_client(
    "FastMCP", agent_topic="my_topic", transport=transport,
    agent_url="http://localhost:8081/mcp"
)
```

**FastMCP — After:**

```python
client = await factory.fast_mcp().create_client(
    url="http://localhost:8081/mcp", topic="my_topic", transport=transport
)
```

---

## Refactor: Split `BaseAgentProtocol` into `ServerHandler` + `ClientFactory`

### Removed

- **`BaseAgentProtocol`** (`semantic/base.py`) — removed entirely. Protocol classes (`A2AProtocol`, `MCPProtocol`, `FastMCPProtocol`) no longer inherit from a shared ABC; they are standalone internal classes.
- **`AgntcyFactory.create_protocol()`** — removed. Use `create_client()` (which now delegates to `ClientFactory` instances) or the handler system for server-side wiring.
- **`AgntcyFactory._protocol_registry`** — replaced by `_client_factory_registry`.
- **`AgntcyFactory.register_protocol()`** — removed (was a classmethod decorator).

### Changed

- **`AppContainer`** — constructor signature changed from `AppContainer(server, transport=..., topic=..., directory=...)` to `AppContainer(handler: ServerHandler)`. All transport wiring logic moved into `ServerHandler.setup()`.
- **`AppSession.add_app_container()`** — still works (deprecated shim) but the preferred API is the fluent builder: `session.add(server).with_transport(...).with_topic(...).with_session_id(...).build()`.
- **`AgntcyFactory.create_client()`** — now `async`. Callers must `await` it. It delegates to `ClientFactory` instances instead of `BaseAgentProtocol` instances.

### Added

- **`ServerHandler`** ABC (`semantic/base.py`) — server-side handler that owns server, transport, topic, and directory. Subclasses: `A2AServerHandler`, `MCPServerHandler`, `FastMCPServerHandler`.
- **`ClientFactory`** ABC (`semantic/base.py`) — standalone client factory per protocol. Subclasses: `A2AClientFactory`, `MCPClientFactory`, `FastMCPClientFactory`.
- **`ContainerBuilder`** (`app_sessions.py`) — fluent API for constructing `AppContainer` instances.
- **`AppSession.add(server)`** — entry point for the fluent builder API.
- Handler auto-detection: `ContainerBuilder.build()` resolves the correct `ServerHandler` subclass from the server type (`A2AStarletteApplication` → `A2AServerHandler`, `MCPServer` → `MCPServerHandler`, `FastMCP` → `FastMCPServerHandler`).

### Migration Guide

**Before (old API):**

```python
from agntcy_app_sdk.app_sessions import AppContainer

transport = factory.create_transport("SLIM", endpoint="http://localhost:46357")
app_container = AppContainer(server, transport=transport, topic="my_topic")
app_session.add_app_container("session_id", app_container)
await app_session.start_all_sessions(keep_alive=True)
```

**After (new API):**

```python
transport = factory.create_transport("SLIM", endpoint="http://localhost:46357")
app_session.add(server).with_transport(transport).with_topic("my_topic").with_session_id("session_id").build()
await app_session.start_all_sessions(keep_alive=True)
```

**Client creation (unchanged for callers):**

```python
client = await factory.create_client("A2A", agent_url="http://localhost:9999")
```
