# agntcy-app-sdk 0.5.0 Migration Guide (for Coding Agents)

This document describes the breaking changes between **0.4.7** (main branch) and **0.5.0** that affect end-user code. It covers four areas: factory client creation, transport creation, app sessions, and A2A protocol topic generation.

> **Audience:** Coding agents (Copilot, Claude Code, Cursor, etc.) performing automated migrations on user projects that depend on `agntcy-app-sdk`.

---

## 1. Factory Client Creation

### Removed: `factory.create_client()` and `factory.create_protocol()`

The generic string-based `create_client()` method on `AgntcyFactory` has been **removed**. The `create_protocol()` method has also been removed. They are replaced by **typed protocol accessors** on the factory: `factory.a2a()`, `factory.mcp()`, and `factory.fast_mcp()`.

#### Before (0.4.7)

```python
from agntcy_app_sdk.factory import AgntcyFactory

factory = AgntcyFactory()

# Creating an A2A client — string-based protocol selection
client = await factory.create_client(
    "A2A",
    agent_url="http://localhost:9999/.well-known/agent",
    agent_topic="Hello_World_Agent_1.0.0",
    transport=transport_instance,
)

# The returned client was an a2a.client.A2AClient with experimental
# methods (broadcast_message, start_groupchat, etc.) monkey-patched on.
response = await client.send_message(request)  # SendMessageRequest in, SendMessageResponse out
```

#### After (0.5.0)

```python
from agntcy_app_sdk.factory import AgntcyFactory
from agntcy_app_sdk.semantic.a2a.client.config import ClientConfig, SlimTransportConfig
from agntcy_app_sdk.semantic.a2a.client.factory import A2AClientFactory

factory = AgntcyFactory()

# Option A: Card-driven factory — pass a ClientConfig and an AgentCard
config = ClientConfig(slim_transport=transport_instance)
# or deferred:
# config = ClientConfig(slim_config=SlimTransportConfig(endpoint="http://...", name="org/ns/name"))
a2a_factory = factory.a2a(config)              # returns A2AClientFactory
client = await a2a_factory.create(agent_card)  # AgentCard in, Client out

# Option B: Convenience class method — resolve card from URL
client = await A2AClientFactory.connect(
    "http://localhost:9999",
    config=ClientConfig(streaming=False),
)

# The returned client is an a2a.client.Client (or A2AExperimentalClient
# when a patterns transport is negotiated). Experimental methods
# (broadcast_message, start_groupchat) are now real methods on the
# A2AExperimentalClient subclass, not monkey-patched functions.
```

### Migration Steps

| What to find | What to replace with |
|---|---|
| `factory.create_client("A2A", agent_url=..., agent_topic=..., transport=...)` | Build a `ClientConfig`, call `factory.a2a(config).create(card)` or `A2AClientFactory.connect(url)` |
| `factory.create_client("MCP", ...)` | `factory.mcp().create_client(topic=..., transport=...)` |
| `factory.create_client("FastMCP", ...)` | `factory.fast_mcp().create_client(topic=..., transport=...)` |
| `factory.create_protocol("A2A")` | `factory.a2a()` (returns `A2AClientFactory`) |
| `factory.create_protocol("MCP")` | `factory.mcp()` (returns `MCPClientFactory`) |
| `factory.create_protocol("FastMCP")` | `factory.fast_mcp()` (returns `FastMCPClientFactory`) |

### Removed: Enum classes `ProtocolTypes`, `TransportTypes`, `ObservabilityProviders`, `IdentityProviders`

These enum classes from `agntcy_app_sdk.factory` have been removed. They were previously used as convenience constants but are no longer needed since the factory methods are now typed.

```python
# Before (0.4.7)
from agntcy_app_sdk.factory import TransportTypes, ProtocolTypes
transport_type = TransportTypes.SLIM.value  # "SLIM"

# After (0.5.0) — use string literals directly
transport_type = "SLIM"
# Or introspect at runtime:
factory.registered_transports()  # ["SLIM", "NATS", "STREAMABLE_HTTP"]
```

### New: `ClientConfig` with transport negotiation

A2A client creation now uses a `ClientConfig` dataclass that extends the upstream `a2a.client.ClientConfig`. Transport negotiation is card-driven: the `AgentCard` declares preferred transports, and the `ClientConfig` auto-derives `supported_transports` from its populated fields.

```python
from agntcy_app_sdk.semantic.a2a.client.config import (
    ClientConfig,
    SlimTransportConfig,
    NatsTransportConfig,
)

# Deferred: transport is built lazily only if the card selects it
config = ClientConfig(
    slim_config=SlimTransportConfig(
        endpoint="http://localhost:46357",
        name="agntcy/demo/client",
    ),
)

# Eager: pass a pre-built transport instance
config = ClientConfig(slim_transport=my_slim_transport)
```

### Changed: A2A client response types

| 0.4.7 | 0.5.0 |
|---|---|
| `client.send_message(SendMessageRequest)` → `SendMessageResponse` | `client.send_message(Message)` → `AsyncIterator[ClientEvent \| Message]` |
| Experimental methods monkey-patched as bare functions | Experimental methods are real methods on `A2AExperimentalClient` |
| `client.agent_card` available directly | `client.agent_card` property on `A2AExperimentalClient` |

---

## 2. Transport Creation

### `factory.create_transport()` — Unchanged API, minor behavior change

The `create_transport()` signature is functionally the same. The only notable difference is error handling: in 0.4.7, an unknown transport type returned `None` (with a warning log). In 0.5.0, it **raises `ValueError`**.

```python
# Both versions
transport = factory.create_transport("SLIM", endpoint="http://localhost:46357", name="org/ns/name")
transport = factory.create_transport("NATS", endpoint="nats://localhost:4222")
```

#### Migration note

If your code checked for a `None` return from `create_transport()`, replace that with a `try/except ValueError`.

```python
# Before (0.4.7)
transport = factory.create_transport(transport_type, endpoint=endpoint)
if transport is None:
    handle_error()

# After (0.5.0)
try:
    transport = factory.create_transport(transport_type, endpoint=endpoint)
except ValueError:
    handle_error()
```

---

## 3. App Sessions (`AppContainer` & `AppSession`)

### Changed: `AppContainer` constructor

The `AppContainer` constructor has been completely reworked. It no longer accepts `server`, `transport`, `topic`, `host`, `port` directly. Instead, it takes a `ServerHandler` instance (resolved automatically via the new `ContainerBuilder`).

#### Before (0.4.7) — Direct construction

```python
from agntcy_app_sdk.app_sessions import AppContainer, AppSession
from agntcy_app_sdk.factory import AgntcyFactory

factory = AgntcyFactory()

# Direct construction with server + transport + topic
container = AppContainer(
    server=a2a_server,           # A2AStarletteApplication
    transport=transport,          # BaseTransport
    topic="Hello_World_Agent_1.0.0",
)

# Manual session management
session = factory.create_app_session(max_sessions=1)
session.add_app_container("my_session", container)
await session.start_all_sessions(keep_alive=True)
```

#### After (0.5.0) — Fluent builder API via `AppSession.add()`

```python
from agntcy_app_sdk.factory import AgntcyFactory

factory = AgntcyFactory()
session = factory.create_app_session(max_sessions=1)

# Fluent builder API — handler type is auto-detected from the server
session.add(a2a_server) \
    .with_transport(transport) \
    .with_topic("Hello_World_Agent_1.0.0") \
    .with_session_id("my_session") \
    .build()

await session.start_all_sessions(keep_alive=True)
```

### New: `ContainerBuilder` fluent methods

| Method | Description |
|---|---|
| `session.add(target)` | Start building — `target` is the server instance (e.g., `A2AStarletteApplication`, `MCPServer`, `FastMCP`) or an `A2ASRPCConfig` |
| `.with_transport(transport)` | Set the `BaseTransport` instance |
| `.with_topic(topic)` | Set the subscription topic |
| `.with_directory(directory)` | Set the agent directory |
| `.with_session_id(session_id)` | Auto-register in the parent `AppSession` |
| `.with_host(host)` | Set the host (default: `"0.0.0.0"`) — used for JSONRPC HTTP serving |
| `.with_port(port)` | Set the port (default: `9000`) — used for JSONRPC HTTP serving |
| `.build()` | Construct the `AppContainer` and register it |

### New: Native HTTP JSONRPC serving without a transport

In 0.5.0, you can serve an A2A server over native HTTP JSONRPC by omitting the transport. The builder auto-detects this and uses `A2AJsonRpcServerHandler` instead.

```python
# 0.5.0 — no transport needed for HTTP-only serving
session.add(a2a_server) \
    .with_host("0.0.0.0") \
    .with_port(9999) \
    .with_session_id("http_session") \
    .build()
```

This replaces the 0.4.7 pattern of manually running uvicorn:

```python
# Before (0.4.7) — manual uvicorn for HTTP serving
from uvicorn import Config, Server
config = Config(app=server.build(), host="0.0.0.0", port=9999, loop="asyncio")
userver = Server(config)
await userver.serve()
```

### Changed: `AppContainer.run()` — `push_to_directory_on_startup` removed

The `push_to_directory_on_startup` parameter has been removed from `AppContainer.run()`. Directory push now happens automatically during `run()` if a directory is set (via `.with_directory()` on the builder).

```python
# Before (0.4.7)
await container.run(keep_alive=True, push_to_directory_on_startup=True)

# After (0.5.0) — directory push is automatic if directory is set
session.add(server) \
    .with_transport(transport) \
    .with_directory(my_directory) \
    .with_session_id("session_1") \
    .build()
await session.start_all_sessions(keep_alive=True)
# Directory push happens automatically in container.run()
```

### Changed: `AppSession.start_all_sessions()` / `start_session()` — `push_to_directory_on_startup` removed

The `push_to_directory_on_startup` kwarg is removed from both `start_all_sessions()` and `start_session()`.

```python
# Before (0.4.7)
await session.start_all_sessions(keep_alive=True, push_to_directory_on_startup=True)

# After (0.5.0)
await session.start_all_sessions(keep_alive=True)
```

### Deprecated: `session.add_app_container()`

The `add_app_container()` method still exists for backwards compatibility but is deprecated. Prefer the fluent builder:

```python
# Deprecated (still works)
session.add_app_container("my_id", container)

# Preferred
session.add(server).with_transport(transport).with_session_id("my_id").build()
```

### Changed: `AppContainer` properties

| 0.4.7 | 0.5.0 |
|---|---|
| `container.server` | Removed — use `container.handler` (a `ServerHandler`) |
| `container.transport` | Now a read-only property delegating to `container.handler.transport` |
| `container.topic` | Now a read-only property delegating to `container.handler.topic` |
| `container.directory` | Now a read-only property |
| `container.protocol_handler` | Removed — replaced by `container.handler` |
| `container.set_transport(t)` | Removed — set via builder |
| `container.set_directory(d)` | Removed — set via builder |
| `container.set_topic(t)` | Removed — set via builder |
| `container.stop()` | Now calls `handler.teardown()` instead of `transport.close()` directly |

---

## 4. A2A Protocol Topic Generation

### Changed: Topic format now replaces spaces with underscores

The `create_agent_topic()` method now replaces spaces with underscores for transport compatibility.

```python
# Before (0.4.7) — A2AProtocol.create_agent_topic()
# For agent_card.name = "Hello World Agent", version = "1.0.0"
topic = A2AProtocol.create_agent_topic(agent_card)
# Result: "Hello World Agent_1.0.0" (spaces preserved)

# After (0.5.0) — A2AExperimentalServer.create_agent_topic()
# Result: "Hello_World_Agent_1.0.0" (spaces replaced with underscores)
```

### Changed: Topic generation location

The `create_agent_topic()` static method has moved from `A2AProtocol` to `A2AExperimentalServer`.

```python
# Before (0.4.7)
from agntcy_app_sdk.semantic.a2a.protocol import A2AProtocol
topic = A2AProtocol.create_agent_topic(agent_card)

# After (0.5.0)
from agntcy_app_sdk.semantic.a2a.server.experimental_patterns import A2AExperimentalServer
topic = A2AExperimentalServer.create_agent_topic(agent_card)
```

> **Note:** In most cases users don't need to call `create_agent_topic()` directly anymore. When using the `ContainerBuilder` without specifying a topic, the `A2AExperimentalServerHandler` auto-derives the topic from the agent card.

### New: Topic encoded in `card.url` for transport discovery

In 0.5.0, when an A2A server is set up with a transport, the server handler automatically overwrites `card.url` with a scheme-encoded topic (e.g., `slim://Hello_World_Agent_1.0.0` or `nats://Hello_World_Agent_1.0.0`). This enables client-side transport negotiation to discover the topic from the card. Clients use `_parse_topic_from_url()` to extract the topic.

### New: `preferred_transport` stamped on agent card

The server handler automatically sets `agent_card.preferred_transport` to `"slimpatterns"` or `"natspatterns"` based on the transport type. This was not done in 0.4.7.

---

## 5. Quick Reference — Full Migration Example

### Server-side (running an A2A agent)

```python
# ========================
# Before (0.4.7)
# ========================
from agntcy_app_sdk.factory import AgntcyFactory
from agntcy_app_sdk.app_sessions import AppContainer

factory = AgntcyFactory(enable_tracing=True)
transport = factory.create_transport("SLIM", endpoint="http://localhost:46357", name="org/ns/agent")

container = AppContainer(
    server=a2a_server,
    transport=transport,
    topic="Hello_World_Agent_1.0.0",
)

session = factory.create_app_session(max_sessions=1)
session.add_app_container("default_session", container)
await session.start_all_sessions(keep_alive=True)

# ========================
# After (0.5.0)
# ========================
from agntcy_app_sdk.factory import AgntcyFactory

factory = AgntcyFactory(enable_tracing=True)
transport = factory.create_transport("SLIM", endpoint="http://localhost:46357", name="org/ns/agent")

session = factory.create_app_session(max_sessions=1)
session.add(a2a_server) \
    .with_transport(transport) \
    .with_topic("Hello_World_Agent_1.0.0") \
    .with_session_id("default_session") \
    .build()
await session.start_all_sessions(keep_alive=True)
```

### Client-side (calling an A2A agent over a transport)

```python
# ========================
# Before (0.4.7)
# ========================
from agntcy_app_sdk.factory import AgntcyFactory

factory = AgntcyFactory(enable_tracing=True)
transport = factory.create_transport("SLIM", endpoint="http://localhost:46357", name="org/ns/client")

client = await factory.create_client(
    "A2A",
    agent_url="http://localhost:9999",
    agent_topic="Hello_World_Agent_1.0.0",
    transport=transport,
)
response = await client.send_message(request)  # SendMessageRequest

# Experimental methods were monkey-patched on:
responses = await client.broadcast_message(request, recipients=[...])
chat_msgs = await client.start_groupchat(request, group_channel="chan", participants=[...])

# ========================
# After (0.5.0)
# ========================
from agntcy_app_sdk.factory import AgntcyFactory
from agntcy_app_sdk.semantic.a2a.client.config import ClientConfig
from agntcy_app_sdk.semantic.a2a.server.experimental_patterns import A2AExperimentalServer
from a2a.types import AgentCard, AgentCapabilities

factory = AgntcyFactory(enable_tracing=True)
transport = factory.create_transport("SLIM", endpoint="http://localhost:46357", name="org/ns/client")

# Build a card (or fetch one from a URL via A2AClientFactory.connect())
base_card = AgentCard(
    name="Hello_World_Agent",
    url="",
    version="1.0.0",
    defaultInputModes=["text"],
    defaultOutputModes=["text"],
    capabilities=AgentCapabilities(),
    skills=[],
)
card = A2AExperimentalServer.create_client_card(base_card, "SLIM")

config = ClientConfig(slim_transport=transport)
client = await factory.a2a(config).create(card)

# send_message now takes a Message and returns an AsyncIterator
async for event in client.send_message(message):
    ...

# Experimental methods are real class methods on A2AExperimentalClient:
responses = await client.broadcast_message(request, recipients=[...])
chat_msgs = await client.start_groupchat(request, group_channel="chan", participants=[...])
```

### Client-side (calling an A2A agent over HTTP JSONRPC)

```python
# ========================
# Before (0.4.7)
# ========================
factory = AgntcyFactory()
client = await factory.create_client("A2A", agent_url="http://localhost:9999")
response = await client.send_message(request)

# ========================
# After (0.5.0)
# ========================
from agntcy_app_sdk.semantic.a2a.client.factory import A2AClientFactory
from agntcy_app_sdk.semantic.a2a.client.config import ClientConfig

client = await A2AClientFactory.connect(
    "http://localhost:9999",
    config=ClientConfig(streaming=False),
)
```

---

## 6. New Imports Summary

Several classes are now exported from the top-level `agntcy_app_sdk` package:

```python
from agntcy_app_sdk import (
    AgntcyFactory,
    A2AClientFactory,
    MCPClientFactory,
    FastMCPClientFactory,
    AppSession,
    AppContainer,
    ClientConfig,
    SlimTransportConfig,
    NatsTransportConfig,
    SlimRpcConfig,
)
```

### Removed imports

```python
# These no longer exist in 0.5.0
from agntcy_app_sdk.factory import ProtocolTypes         # removed
from agntcy_app_sdk.factory import TransportTypes        # removed
from agntcy_app_sdk.factory import ObservabilityProviders # removed
from agntcy_app_sdk.factory import IdentityProviders     # removed
from agntcy_app_sdk.semantic.a2a.protocol import A2AProtocol  # removed (replaced by A2AClientFactory + server handlers)
from agntcy_app_sdk.semantic.base import BaseAgentProtocol     # removed (replaced by ServerHandler + BaseClientFactory)
```
